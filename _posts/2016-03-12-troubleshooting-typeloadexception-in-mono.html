---
layout: post
title: Troubleshooting TypeLoadException in mono
date: 2016-03-12 06:59:35.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Code
tags:
- ".NET"
- mono
- troubleshooting
- TypeLoadException
meta:
  _edit_last: '14213986'
  restapi_import_id: 586b47d26eba1
  original_post_id: '319'
  _wp_old_slug: '319'
  _publicize_job_id: '4016719513'
author:


  display_name: ngeor
  first_name: Nikolaos
  last_name: Georgiou
---
<p>I don't do a lot of .NET programming these days. At work we deal mostly with JavaScript. However, C# is still the language I'm more fluent in and, also important, a language that I really like. That's why sometimes I like to code a bit in C# at home. That can be either on Windows or on a Mac with Mono. The problem with Mono is that things can always be a bit different and require some extra effort.<!--more--></p>
<p>This time IÂ am working on <a href="https://github.com/ngeor/GoogleDriveOfflineBackup" target="_blank">a project that downloads your entire Google Drive locally</a>. The twist is that it automatically converts Google Docs/Sheets/etc into their Microsoft (or OpenOffice) counterpart formats. That's not what Google Drive does. With Google Drive, these files are stored locally as small JSON files, mere pointers to the data in the cloud. If you want to be a bit more in control of your data, but you don't want to setup your own cloud, maybe a periodic export to concrete formats like docx is the answer.</p>
<p>Anyway, back to my Mono problems. The project was running fine on Windows, but on my Mac (mono 4.2.3) I ended up in a TypeLoadException:</p>
<p>[code]<br />
$ mono GoogleDriveOfflineBackup.CLI.exe</p>
<p>Unhandled Exception:<br />
System.TypeLoadException: Could not load type 'Google.Apis.Drive.v3.DriveService' from assembly 'Google.Apis.Drive.v3, Version=1.10.0.13, Culture=neutral, PublicKeyToken=4b01fa6e34db77ab'.<br />
  at GoogleDriveOfflineBackup.CLI.Program.Main (System.String[] args) &lt;0x6b4f70 + 0x00027&gt; in &lt;filename unknown&gt;:0<br />
[ERROR] FATAL UNHANDLED EXCEPTION: System.TypeLoadException: Could not load type 'Google.Apis.Drive.v3.DriveService' from assembly 'Google.Apis.Drive.v3, Version=1.10.0.13, Culture=neutral, PublicKeyToken=4b01fa6e34db77ab'.<br />
  at GoogleDriveOfflineBackup.CLI.Program.Main (System.String[] args) &lt;0x6b4f70 + 0x00027&gt; in &lt;filename unknown&gt;:0<br />
[/code]</p>
<p>It's complaining about a DLL from Google Drive API, but that DLL is definitely in the correct folder and it is definitely the correct version.</p>
<p>In this case, the problem lies with a dependency of a dependency. To troubleshoot it, you have to invoke mono in a special way. If you run the same command with the environment variable MONO_LOG_LEVEL set to debug, you'll get a much longer output. Somewhere close to the end you'll find the real culprit:</p>
<p>[code]<br />
$ MONO_LOG_LEVEL=debug mono GoogleDriveOfflineBackup.CLI.exe<br />
[...]<br />
Mono: The following assembly referenced from Google.Apis.Core.dll could not be loaded:<br />
     Assembly:   System.Net.Http    (assemblyref_index=5)<br />
     Version:    1.5.0.0<br />
     Public Key: b03f5f7f11d50a3a<br />
The assembly was not found in the Global Assembly Cache, a path listed in the MONO_PATH environment variable, or in the location of the executing assembly.</p>
<p>Mono: Failed to load assembly Google.Apis.Core[0x796886a0]</p>
<p>Mono: Could not load file or assembly 'System.Net.Http, Version=1.5.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a' or one of its dependencies.<br />
[...]<br />
[/code]</p>
<p>So the missing library is actually System.Net.Http version 1.5.0.0. That's more useful. Poking around in the project's references in Xamarin Studio, I was able to see that it already uses System.Net.Http, but version 4.0.0.0. To use that, we'll need a binding redirect in the app.config:</p>
<p>[code]<br />
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;<br />
&lt;configuration&gt;<br />
    &lt;startup&gt;<br />
        &lt;supportedRuntime version=&quot;v4.0&quot; sku=&quot;.NETFramework,Version=v4.5&quot; /&gt;<br />
    &lt;/startup&gt;<br />
  &lt;runtime&gt;<br />
    &lt;assemblyBinding xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot;&gt;<br />
      &lt;dependentAssembly&gt;<br />
        &lt;assemblyIdentity name=&quot;System.Net.Http&quot; publicKeyToken=&quot;b03f5f7f11d50a3a&quot; culture=&quot;neutral&quot; /&gt;<br />
        &lt;bindingRedirect oldVersion=&quot;0.0.0.0-4.0.0.0&quot; newVersion=&quot;4.0.0.0&quot; /&gt;<br />
      &lt;/dependentAssembly&gt;<br />
    &lt;/assemblyBinding&gt;<br />
  &lt;/runtime&gt;<br />
&lt;/configuration&gt;<br />
[/code]</p>
<p>And that workaround makes the project work again in Mono. Hope this helps!</p>
